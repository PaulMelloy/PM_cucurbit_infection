---
title: "Temperature and VPD effects on *P. xanthii* germination"
description: |
  Investigating the effect of temperature and VPD on *Podosphera xanthii* conida 
  in cucurbits
author:
  - name: Paul Melloy 
    affiliation: The University of Queensland
    affiliation_url: https://uq.edu.au
date: "`r Sys.Date()`"
output: distill::distill_article
---

Load R libraries required for analysis

```{r load_libraries, warning=FALSE}
library(data.table)
library(mgcv)
library(lme4)
library(ggplot2)
```
<br>  

Import the clean data

```{r import_data}
g_tm <- fread("cache/germination_temperature.csv")
g_vpd <- fread("cache/germination_response_to_vpd.csv")
```

<br>  
<br>  

## Impact of Temperature on *P. xanthii* germination  
Peek at the data

```{r data_peek}
head(g_tm)
str(g_tm)
```
<br>  
### Visualise the raw data  
Let's plot the data over time  

```{r plot_raw_time}
g_tm |>
   ggplot(aes(x = i_period, y = germ_conidia, colour = as.factor(Tm))) + 
   geom_point()+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 3))+
   scale_color_viridis_d()+
   xlab("Time in hours")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic()+
   scale_x_continuous(limits = c(12,48), breaks = c(12,18,24,30,36,42,48))+
   scale_y_continuous(limits = c(0,100), n.breaks = 5)
   
```
<br>  
Now lets plot germination over temperature separating by infection period.  

```{r plot_raw_Tm}
g_tm |>
   ggplot(aes(x = Tm, y = germ_conidia, colour = as.factor(i_period))) + 
   geom_point()+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 6))+
   scale_color_viridis_d()+
   xlab("Temperature")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Time (h)")+
   theme_classic()+
   #scale_x_continuous(limits = c(12,48), breaks = c(12,18,24,30,36,42,48))+
   scale_y_continuous(limits = c(0,100), n.breaks = 5)
```
Splines fit with four knots.  

These plot shows that the optimum temperature for rapid *P. xanthii* germination 
is around 28C. 
Also, in the first plot, if we assume at time zero there was no germinated conidia, 
50% of the conidia germinated within the first 12 hours. 
In all temperature treatments, between 12 and 36 hours after infection conidial 
germination increased at a linear rate. 
After 36 hours the rate of conidia germinating declined to almost zero.
Curves were fit using a generalised additive model with a smooth spline containing 6 knots.  

Lets further evaluate this fit.
However instead of fitting a temperature as a separate random effect, as depicted 
in the above plot, we will define temperature as a separate continuous predictor 
that may or may not interact with infection period.  

Germination is a binomial response so we need to provide the number of germinated 
to the number of non-germinated.
In the first model we will fit a smooth spline to each predictor and specify that each 
predictor influences germination independently of the other.
I have used only 2 and 4 basis spline 'knots' for infection period and temperature
respectively.  

```{r model_1}
m1 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4), 
          data = g_tm,
          family = "binomial")
summary(m1)
plot(m1)
vis.gam(m1,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
<br>  
Model two we will investigate whether there is an interaction between temperature 
and infection period.  

```{r model_2}
m2 <- gam(cbind(germ_conidia, non_germ_conidia) ~ te(i_period, Tm, k = 4),
          data = g_tm,
          family = "binomial")
summary(m2)
plot(m2)
vis.gam(m2, 
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
This model shows slightly higher R squared and 'explained deviance' values, with 
a lower UBRE  value indicating that model two (`m2`) is the better model.  

Lets compare the models against each other.

```{r compare_m1m2}
anova(m1,m2, test = "Chisq")
```
This confirms that model two is the better model and explains more of the deviance.  

<br>  

Yet this model does not tend to reflect the raw data. 
The plots of the fitted model indicate that 28C showed the highest colonial germination. 
This might be due to the default type of basis splines, and number of knots. 
We have exhausted our options for improving the interaction, so let us investigate
improving the additive model by fitting a better spline to the temperature predictor.  

P-splines use a penalised least-square method to fit the model and are better in
non-normal distributions.
Lets try p splines to see if we can improve the fit.

```{r model_3}
m3 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4, bs = "ps"),
          data = g_tm,
          family = "binomial")
summary(m3)
plot(m3)
vis.gam(m3,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
The P-splines have improved the predictive ability of the model with a lower UBRE, 
improved the R squared value and explained deviance.
We can also see that the curve has been shifted slightly up towards 28C.  


Lets compare the models two and three to against each other.

```{r comp_m2m3}
anova(m2,m3, test = "Chisq")
```
The models show no significant difference therefore we should use the simpler model,
model three (`m3`). 
Model three also shows a better fit to the data.  
  
<br>  
  
Next lets see if cyclic versions of the p-splines `"cp"` improve this fit further.

```{r model_4}
m4 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4, bs = "cp"),
          data = g_tm,
          family = "binomial")
summary(m4)
plot(m4)
vis.gam(m4,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
The cyclic P-splines seem to have improved the predictive ability of the model 
with a very low UBRE, also improving the R squared value and explaining more deviance.
We can also see that the curve has been shifted further towards 28C, however the
the willingness of the model implies it might be overfit, especially between the 
temperature ranges 20 - 24C.  

<br>  
  
Lets compare the models three and four to against each other.

```{r comp_m3m4}
anova(m3,m4, test = "Chisq")
```
The models show no significant difference, therefore we should keep the simpler 
model.  

<br>  

Lets use the p splines again however increase the number of knots for temperature
in attempt to get a better fit to the raw data.

```{r model_5}
m5 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =6, bs = "ps"),
          data = g_tm,
          family = "binomial")
summary(m5)
plot(m5)
vis.gam(m5,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
This model has less "wiggliness", higher R-squared, explained more deviance and 
has the lowest UBRE score.  


Lets compare the models four and five to against each other.  

```{r comp_m4m5}
anova(m4,m5, test = "Chisq")
```
The p-spline model with more knots explained the most deviance and provides a 
significantly better fit.

And look at the AIC values of all the models.

```{r AIC_all}
AIC(m1,m2,m3,m4,m5)
```

This shows that model five is the best fit, with the lowest AIC and an R squared
of `r round(summary(m5)$r.sq, 4)`.
Temperature and infection period are significant predictors and the model produces
a low UBRE score or `r round(m5$gcv.ubre,3)`, indicating good predictive ability
and less affected by drop one, tests.



<br>  
<br>  

## Impact of Temperature on *P. xanthii* germination  
Peek at the data

```{r data_peek2}
head(g_vpd)
str(g_vpd)
```
<br>  
### Visualise the raw data  
Let's plot the data over time  

```{r plot_raw_timexRH}
g_vpd |>
   ggplot(aes(x = i_period, y = germ_n, colour = as.factor(Tm))) + 
   geom_point()+
   facet_wrap(facets = "RH")+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 3))+
   scale_color_viridis_d()+
   xlab("Time in hours")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic() +
   ggtitle("Germinated conidia over time, subset by relative humidity")
   # scale_x_continuous(limits = c(12,48), breaks = c(12,18,24,30,36,42,48))++
   # scale_y_continuous(limits = c(0,100), n.breaks = 5)
   
```



```{r plot_raw_timexVPD}
i_p_labs <-c("12 hours","24 hours","36 hours","48 hours")
names(i_p_labs) <- c(12,24,36,48)
g_vpd |>
   ggplot(aes(x = vpd, y = germ_n, colour = as.factor(Tm))) + 
   geom_point()+
   facet_wrap(facets = c("i_period"), 
              labeller = labeller(i_period = i_p_labs))+
   geom_smooth(method = "gam",formula = y ~ s(x,k=5), se = FALSE)+
   scale_color_viridis_d()+
   xlab("VPD")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic()

```

This data is very hard to fit a curve to and seems like it would benefit with two functions.
Lets plot again without the saturated 99% humidity treatment
```{r plot_subset_rh}
i_p_labs <-c("12 hours","24 hours","36 hours","48 hours")
names(i_p_labs) <- c(12,24,36,48)
g_vpd[g_vpd$RH != 99] |>
   ggplot(aes(x = vpd, y = germ_n, colour = as.factor(Tm))) + 
   geom_point()+
   facet_wrap(facets = c("i_period"), 
              labeller = labeller(i_period = i_p_labs))+
   geom_smooth(method = "gam",formula = y ~ s(x,k=5), se = FALSE)+
   scale_color_viridis_d()+
   xlab("VPD")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic()
```

From these plots it seems that the influence of VPD on germination is bimodal, with an increase in germination between 1.5 and 2 kPa. 
Particularly in the warmer treatments

### VPD influence on germination - analysis
```{r m1v}
m1v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 5) + s(Tm, k = 3) + s(i_period, k = 3), 
           data = g_vpd,
           family = "binomial")
summary(m1v)
plot(m1v)
vis.gam(m1v)
```

As earlier, lets try and reduce the wiggliness by using P-splines  

```{r m2v}
m2v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 5, bs = "ps") + s(Tm, k = 3) + s(i_period, k = 3), 
           data = g_vpd,
           family = "binomial")
summary(m2v)
plot(m2v)
vis.gam(m2v,
        phi = 20,
        theta = 45)
```

There is a better fit and a more decreasing trend in the vpd plot.  

Next lets try more vpd knots

```{r m3v}
m3v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 8, bs = "ps") + s(Tm, k = 3) + s(i_period, k = 3), 
           data = g_vpd,
           family = "binomial")
summary(m3v)
plot(m3v)
vis.gam(m3v,
        phi = 20,
        theta = 45)
par(mfrow = c(2,2))
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 12))
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 24))
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 36))
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 48))

par(mfrow = c(1,1))
```

While there exists a lot of wiggliness in the gam, the vpd plot shows the increase in germination in at around 1.5 kPa and the rapid decrease in germination between the saturated treatments (0.026 - 0.038 kPa) and the next highest humidity (0.158 - 0.189 kpa).
This model also provides a high R-squared (`r round(summary(m3v)$r.sq,4)`), low UBRE `r round(m3v$gcv.ubre,3)`, indicating good predictive ability
and less affected by drop one, tests.

```{r}
anova(m2v,m3v)
AIC(m1v,m2v,m3v)
```







