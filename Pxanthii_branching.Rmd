---
title: "Germtube production"
author: "P. Melloy"
date: "04/05/2022"
output: html_document
---


Load R libraries required for analysis

```{r load_libraries, warning=FALSE}
library(data.table)
library(mgcv)
library(rstanarm)
library(lme4)
library(ggplot2)
```
<br>  

Import the clean data

```{r import_data}
# Read clean data
b_vpd <- fread("cache/branching_vpd.csv")
b_tm_vpd <- fread("cache/branching_temperature&VPD.csv")
b_tm_vpd2 <- fread("cache/branching_under_vpd&Tm.csv")

```

<br>  
<br>  

## Impact of Temperature on *P. xanthii* germination  
Peek at the data

```{r data_peek}
str(b_vpd)
str(b_tm_vpd)
str(b_tm_vpd2)

unique(b_vpd$Tm)
unique(b_vpd$vpd)



```
<br>  
### Visualise the raw data  
Let's plot the data over time  

```{r plot_raw_time}
b_vpd[,germ_p := (n/non_germ)*100] 
b_vpd |>
   ggplot(aes( x = as.factor(vpd), y = germ_p , fill = as.factor(germ_tubes))) + 
   geom_col(position = "stack")+
   scale_fill_brewer(palette = "Blues", name = "Germ tubes")+
   xlab("Vapour pressure deficit")+
   ylab("Percent germinated")+
   labs(colour = "Germ tubes")+
   theme_classic()+
   geom_label(aes(x = as.factor(vpd), y = 4, label = Tm))+
   scale_y_continuous(limits = c(0,100))
```
<br>  


```{r model_1}
b_vpd_lng <-
   rbindlist(apply(b_vpd, 1 , function(x) {
      rbindlist(c(lapply(seq_len(x["n"]), function(x2) {
         as.data.frame(t(x[c(1:5)]))
      }),
      lapply(seq_len(x["non_germ"]), function(x2) {
         as.data.frame(t(c(x[c(1:4)],
                           germ_tubes = 0)))
      })))
      
   }))

b_vpd_lng[, c("rep",
              "germ_tubes",
              "cham",
              "vpd") := list(as.integer(rep),
                             as.ordered(germ_tubes),
                             paste0(Tm, RH),
                             as.numeric(vpd))]

b_vpd[, c("rep", 
              "germ_tubes", 
              "cham",
          "vpd") := list(as.integer(rep),
                            as.integer(germ_tubes),
                            paste0(Tm,RH),
                         as.numeric(vpd))]


m1 <- glmer(germ_tubes ~ vpd + (vpd|cham/rep), 
          data = b_vpd_lng)

m2 <- glmer(n ~ germ_tubes * vpd + (vpd|cham/rep), 
          data = b_vpd,
          family = "poisson")
summary(m2)

```

```{r}
m1.1 <- stan_polr(germ_tubes ~ vpd , chains = 1,
                  prior = R2(0.5, what = "median"), 
                  data = b_vpd_lng)
summary(m1.1)


```


<br>  
Model two we will investigate whether there is an interaction between temperature 
and infection period.  

```{r model_2}
m2 <- gam(cbind(germ_conidia, non_germ_conidia) ~ te(i_period, Tm, k = 4),
          data = g_tm,
          family = "binomial")
summary(m2)
plot(m2)
vis.gam(m2, 
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
This model shows slightly higher R squared and 'explained deviance' values, with 
a lower UBRE  value indicating that model two (`m2`) is the better model.  

Lets compare the models against each other.
