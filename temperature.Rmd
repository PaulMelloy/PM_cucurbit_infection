---
title: "The effect of temperature on Podosphera xanthii germination and branching"
description: |
  The statistical method undertaken in analysing the effect of temperature on 
  the germination and branching of  _P. xanthii_.  
author:
  - name: Paul Melloy
    url: https://PaulMelloy.github.io
    affiliation: The University of Queensland
    affiliation_url: https://uq.edu.au
date: "`r Sys.Date()`"
output: distill::distill_article
---

Load R libraries required for analysis

```{r load_libraries, warning=FALSE, message=FALSE}
library(data.table) # data structure, cleaning and formatting
library(mgcv) # gam statistical models
library(rstanarm) # Bayesian statistical models
library(lme4) # Linear mixed effect modelling
library(ggplot2) # graphing
library(MASS) # logistical ordinal regression functions, among other things
```
<br>  

```{r import_data}
g_tm <- fread("cache/germination_temperature.csv")
br_tm <- fread("cache/branching_temperature.csv")
```



<br>  
<br>  

## Impact of Temperature on *P. xanthii* germination  
Peek at the data

```{r data_peek}
head(g_tm)
str(g_tm)
```
<br>  
### Visualise the raw data  
Let's plot the data over time, we will need to omit temperatures 8 and 35 where
no germination was observed.

```{r plot_raw_time}
g_tm[Tm != 8 &
        Tm != 35,] |>
   ggplot(aes(x = i_period, y = germ_conidia, colour = as.factor(Tm))) + 
   geom_point()+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 3))+
   scale_color_viridis_d()+
   xlab("Time in hours")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic()+
   scale_x_continuous(limits = c(12,48), breaks = c(12,18,24,30,36,42,48))+
   scale_y_continuous(limits = c(0,100), n.breaks = 5)
   
```
<br>  
Now lets plot germination over temperature separating by infection period.  

```{r plot_raw_Tm}
g_tm |>
   ggplot(aes(x = Tm, y = germ_conidia, colour = as.factor(i_period))) + 
   geom_point()+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 3), se =FALSE)+
   scale_color_viridis_d()+
   xlab("Temperature")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Time (h)")+
   theme_classic()+
   #scale_x_continuous(limits = c(12,48), breaks = c(12,18,24,30,36,42,48))+
   scale_y_continuous(limits = c(0,100), n.breaks = 5)
```
Splines fit with four knots.  

These plot shows that the optimum temperature for rapid *P. xanthii* germination 
is around 28C. 
Also, in the first plot, if we assume at time zero there was no germinated conidia, 
50% of the conidia germinated within the first 12 hours. 
In all temperature treatments, between 12 and 36 hours after infection conidial 
germination increased at a linear rate. 
After 36 hours the rate of conidia germinating declined to almost zero.
Curves were fit using a generalised additive model with a smooth spline containing 6 knots.  

Lets further evaluate this fit.
However instead of fitting a temperature as a separate random effect, as depicted 
in the above plot, we will define temperature as a separate continuous predictor 
that may or may not interact with infection period.  

Germination is a binomial response so we need to provide the number of germinated 
to the number of non-germinated.
In the first model we will fit a smooth spline to each predictor and specify that each 
predictor influences germination independently of the other.
I have used only 2 and 4 basis spline 'knots' for infection period and temperature
respectively.  

```{r model_1}
m1 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4), 
          data = g_tm,
          family = "binomial")
summary(m1)
plot(m1)
vis.gam(m1,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
<br>  
Model two we will investigate whether there is an interaction between temperature 
and infection period.  

```{r model_2}
m2 <- gam(cbind(germ_conidia, non_germ_conidia) ~ te(i_period, Tm, k = 4),
          data = g_tm,
          family = "binomial")
summary(m2)
plot(m2)
vis.gam(m2, 
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
This model shows slightly higher R squared and 'explained deviance' values, with 
a lower UBRE  value indicating that model two (`m2`) is the better model.  

Lets compare the models against each other.

```{r compare_m1m2}
anova(m1,m2, test = "Chisq")
```
This confirms that model two is the better model and explains more of the deviance.  

<br>  

Yet this model does not tend to reflect the raw data. 
The plots of the fitted model indicate that 28C showed the highest colonial germination. 
This might be due to the default type of basis splines, and number of knots. 
We have exhausted our options for improving the interaction, so let us investigate
improving the additive model by fitting a better spline to the temperature predictor.  

P-splines use a penalised least-square method to fit the model and are better in
non-normal distributions.
Lets try p splines to see if we can improve the fit.

```{r model_3}
m3 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4, bs = "ps"),
          data = g_tm,
          family = "binomial")
summary(m3)
plot(m3)
vis.gam(m3,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
The P-splines have improved the predictive ability of the model with a lower UBRE, 
improved the R squared value and explained deviance.
We can also see that the curve has been shifted slightly up towards 28C.  


Lets compare the models two and three to against each other.

```{r comp_m2m3}
anova(m2,m3, test = "Chisq")
```
The models show no significant difference therefore we should use the simpler model,
model three (`m3`). 
Model three also shows a better fit to the data.  
  
<br>  
  
Next lets see if cyclic versions of the p-splines `"cp"` improve this fit further.

```{r model_4}
m4 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4, bs = "cp"),
          data = g_tm,
          family = "binomial")
summary(m4)
plot(m4)
vis.gam(m4,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
The cyclic P-splines seem to have improved the predictive ability of the model 
with a very low UBRE, also improving the R squared value and explaining more deviance.
We can also see that the curve has been shifted further towards 28C, however the
the willingness of the model implies it might be overfit, especially between the 
temperature ranges 20 - 24C.  

<br>  
  
Lets compare the models three and four to against each other.

```{r comp_m3m4}
anova(m3,m4, test = "Chisq")
```
The models show no significant difference, therefore we should keep the simpler 
model.  

<br>  

Lets use the p splines again however increase the number of knots for temperature
in attempt to get a better fit to the raw data.

```{r model_5}
m5 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =6, bs = "ps"),
          data = g_tm,
          family = "binomial")
summary(m5)
plot(m5)
vis.gam(m5,
        theta = -50, # horizontal rotation
        phi = 30, # vertical rotation
        n.grid = max(g_tm$Tm) - min(g_tm$Tm) # grid cells
        )
```
This model has less "wiggliness", higher R-squared, explained more deviance and 
has the lowest UBRE score.  


Lets compare the models four and five to against each other.  

```{r comp_m4m5}
anova(m4,m5, test = "Chisq")
```
The p-spline model with more knots explained the most deviance and provides a 
significantly better fit.

And look at the AIC values of all the models.

```{r AIC_all}
AIC(m1,m2,m3,m4,m5)
```

This shows that model five is the best fit, with the lowest AIC and an R squared
of `r round(summary(m5)$r.sq, 4)`.
Temperature and infection period are significant predictors and the model produces
a low UBRE score or `r round(m5$gcv.ubre,3)`, indicating good predictive ability
and less affected by drop one, tests.

***  

## Temperature effect on germtube branching  

Peek at the data  

```{r data_peek}
head(br_tm)
str(br_tm)
summary(br_tm)
```

This experiment used the same leaves as the germination experiment which were incubated
for 36 hours. 
Following 36 hours of incubation at each respective temperatures, four leaf discs
were removed from the growth chamber and sticky tape used to make a slide of the conidia
from the surface of the leaf. 
Two additional leaf discs were removed from the same chamber at the same time, stained 
and fixed for microscopy using the leaf clearing method, described by Jose Liberato. 
One hundred conidia were selected at random and the state of germination or branching
recorded.

<br>  
### Visualise the raw data  
Let's plot the data over time  

```{r plot_raw_time}
br_tm |>
   ggplot(aes( x = as.factor(Tm), y = conidia/2 , fill = as.factor(branches))) + 
   geom_col(position = position_stack(reverse = TRUE))+
   scale_fill_brewer(palette = "Blues", name = "Germ tube/\nbranches")+
   xlab("Temperature")+
   ylab("Conidia")+
   labs(colour = "Germ tubes")+
   theme_classic()
   
```

This plot shows that the optimum temperature for rapid *P. xanthii* germination 
is around 28C. 
Also, no germination occurs at temperatures 8$^\circ$C or less, and over 35$^\circ$C.

Lets build a model to help us predict what state a conidia will be in, after 36 
hours when incubated at each respective temperature.

Here we have a response variable, `branches` which describes the progress of a potential
infection by a single conidia.  
   - `0` which represents a non-germinated conidia,  
   - `1` a germinated conidia with one germ tube,  
   - `2` a germinated conidia with two germ tubes,  
   - `3` a germinated conidia with three or more germ tubes.  
   
The response variable is might be thought of as continuous. 
However the given our aim is to estimate the survival of conidia on a cucurbit leaf,
and if successful infection might occur estimating the number of branched hyphae 
beyond three is meaningless, given Trecate (2019) assumes successful infection of
a host cell if there are more than 2 germ tubes.
`branches` would be better characterised as ordinal and therefore leads us to using
*ordinal logistic regression* methods.  

### Ordinal logistic regression  
The aim of this analysis is to predict the likelihood of a conidia germinating and 
branching under different temperature conditions.  
We could state that the response variable is the state of the conidia, wheather 
it be non-germinated (0), germinated (1), branched (2), or twice branched (3) with three germ-tubes.
Because this is count data and our response is not binomial but multinomial and 
ordered,the type of analysis we should use is an ordinal logistic regression.  

First we need to convert the count data into a longer format, so each row represents
an observation.  

```{r to_long}
br_tm_lng <-
   rbindlist(apply(br_tm, 1 , function(x) {
      rbindlist(lapply(seq_len(x["conidia"]), function(x2) {
         as.data.frame(t(x[c(1:3)]))
      }))
   }))

# classify each column
br_tm_lng[, c("Tm", "branches", "rep") := list(Tm,
                                               ordered(branches), 
                                               as.factor(rep))]
```

Now we have prepared our data lets try it in our first model.  

```{r m1}
m1 <- polr(branches ~ Tm + rep, 
           data = br_tm_lng, 
           Hess = TRUE)

summary(m1)
```

The output is in proportional log odds and presents *Coefficients* which represent
the change in log odds for each unit of the predictor.
For example for each degree temperature increases the log odds increases `r round(coef(m1)[1],3)`.  

The coefficient `rep` is not significiant and can probably be dropped from the model.  

Lets plot the model predictions for temperatures between 8$^\circ$ C and 35$^\circ$ C
to determine if the result is reasonable compared to the raw data.  

```{r plot_m1}
# Make a data.frame of test values to feed in the model
test_dat <- data.table(Tm = 5:40, # between 5 and 8 degrees
                       rep = as.factor(rbinom(length(5:40),1,0.5)+1)) # randomly use either the first or second rep

# create a data.frame with predicted values and reference them to the respective temperature
m1_pred <-
   as.data.table(cbind(Tm = test_dat$Tm,
                       round(predict(m1,
                                     test_dat,
                                     type = "p"),
                             3)))

# format to long 
m1_pred <-
   melt(
      m1_pred,
      id.vars = "Tm",
      measure.vars = c("0", "1", "2", "3"),
      variable.name = "branches",
      value.name = "prob"
   )

m1_pred |>
   ggplot(aes(Tm, prob, colour = branches))+
   geom_line(size = 1)+
   theme_minimal()
```

The result is rather linear and predicts more branches at 40C when the raw data does not see any from 35C or presumably above.

Lets try applying some splines to temperature and dropping rep.  


```{r m2}
library(splines)
m2 <- polr(branches ~ bs(Tm,Boundary.knots = c(8,35)), 
                         data = br_tm_lng, Hess = TRUE)
summary(m2)
```
The residual deviance and AIC on this model is lower, indicating this might be a 
better fit. 
Also the t value is higher hinting this model shows clearer differences between 
the variables.  

Now lets try predicting from this model.  

```{r pred_m2}
m2_pred <- as.data.table(round(predict(m2,
                         test_dat,
                         type = "p"),
                 3))[, Tm := test_dat$Tm]

```
We get a warning indicating the the predicted values are outside the range of the 
spline boundary knots. 
This is ok as we know there should be a zero probability of spore germination outside 
this temperature range of 8$^\circ$C and 35$^\circ$C

```{r}
# format to long 
m2_pred <-
   melt(
      m2_pred,
      id.vars = "Tm",
      measure.vars = c("0", "1", "2", "3"),
      variable.name = "branches",
      value.name = "prob"
   )

m2_pred |>
   ggplot(aes(Tm, prob, colour = branches))+
   geom_line(size = 1)+
   theme_minimal()
```

This plot looks like it would fit the raw data much better than `m1`.
However, the model is more centered on 25$^\circ$C as the temperature producing the
most germinated conidia with three germ-tubes.
Lets see if we can improve the model by adding more knots.


```{r m3}
m3 <- polr(branches ~ bs(Tm,
                         knots = c(19,23,27,30)), 
                         data = br_tm_lng, Hess = TRUE)
summary(m3)
```
The residual deviance and AIC on this model is lower, indicating this might be a 
better fit. 
Also the t value is higher hinting this model shows clearer differences between 
the variables.  

Now lets try predicting from this model.  

```{r pred_m3}
m3_pred <- as.data.table(round(predict(m3,
                         test_dat[,1],
                         type = "p"),
                 3))[, Tm := test_dat$Tm]

```
We get a warning indicating the the predicted values are outside the range of the 
spline boundary knots. 
This is ok as we know there should be a zero probability of spore germination outside 
this temperature range of 8$^\circ$C and 35$^\circ$C

```{r plot_m3}
# format to long 
m3_pred <-
   melt(
      m3_pred,
      id.vars = "Tm",
      measure.vars = c("0", "1", "2", "3"),
      variable.name = "branches",
      value.name = "prob"
   )

m3_pred |>
   ggplot(aes(Tm, prob, colour = branches))+
   geom_line(size = 1)+
   theme_minimal()
```

The plot shows that this model might have too many spline knots. 
Lets compare the mode using the `anova()` function.

```{r anova_m3}
anova(m2,m3)
```
While the anova says `m3` is a significantly better model, the residual deviance 
informs us it is not by much. 
Based on the plot we will try fewer knots to reduce the wiggliness


```{r m4}
m4 <- polr(branches ~ bs(Tm,
                         knots = c(23,28)), 
                         data = br_tm_lng, Hess = TRUE)
summary(m4)
```
The residual deviance and AIC on this model is lower, indicating this might be a 
better fit. 
Also the t value is higher hinting this model shows clearer differences between 
the variables.  

Now lets try predicting from this model.  

```{r pred_m4}
m4_pred <-
   as.data.table(round(predict(m4,
                               test_dat[, 1],
                               type = "p",
                               se.fit = TRUE),
                       3))[, Tm := test_dat$Tm]

```
We get a warning indicating the the predicted values are outside the range of the 
spline boundary knots. 
This is ok as we know there should be a zero probability of spore germination outside 
this temperature range of 8$^\circ$C and 35$^\circ$C

```{r plot_m4}
# format to long 
m4_pred <-
   melt(
      m4_pred,
      id.vars = "Tm",
      measure.vars = c("0", "1", "2", "3"),
      variable.name = "branches",
      value.name = "prob"
   )

m4_pred |>
   ggplot(aes(Tm, prob, colour = branches))+
   geom_line(size = 1)+
   theme_minimal()+
   geom_vline(aes(xintercept = 28), linetype = 2)+
   annotate(geom = "text",
            x = 29,
            y = 0.9,
            label = 28)
```

The plot shows a smoother fit with the knots we have tried. 
Lets compare the model using the `anova()` function.

```{r anova_m3}
anova(m3,m4)
```
While the anova says `m3` is a significantly better model, the residual deviance 
informs us it is not by much. 
Based on the plot we will try fewer knots to reduce the wiggliness

