---
title: "The effect of vapour pressure deficit on *Podosphera xanthii* germination and germ tube production"
description: |
  The statistical method undertaken in analysing the effect of temperature on 
  _P. xanthii_ germination and germ-tube production.  
author:
  - name: Paul Melloy
    url: https://PaulMelloy.github.io
    affiliation: The University of Queensland
    affiliation_url: https://uq.edu.au
date: "`r Sys.Date()`"
output: distill::distill_article
---


Load R libraries required for analysis

```{r load_libraries, warning=FALSE, message=FALSE}
library(data.table) # data structure, cleaning and formatting
library(mgcv) # gam statistical models
library(rstanarm) # Bayesian statistical models
library(ggplot2) # graphing
library(MASS) # logistical ordinal regression functions, among other things
library(splines) # non-linear predictors
source("R/p_star.R")
```
<br>  

## Impact of Vapour pressure deficit on *P. xanthii* germination  

Read in data

```{r import_data}
g_vpd <- fread("cache/germination_vpd.csv")
```

<br>  

Peek at the data

```{r data_peek}
str(g_vpd)
# inspect environmental treatments
unique(g_vpd[,.(RH,Tm,vpd)])
```
This table shows there are 18 VPD treatments consisting of six relative humidity
and three temperatures.  

Sampling times in hours.  

```{r}
g_vpd[, .(reps = paste0(range(rep), collapse = " - ")), by = i_period]
```

<br>  

How many leaves were inoculated?  

```{r}
length(unique(g_vpd$vpd)) *           # Temperature incubators
   length(unique(g_vpd$rep)) *      # individual leaves
   length(unique(g_vpd$i_period))    # Sampling times
```

Add the number of leaves sampled at 36 hours to count germ-tube branching.  

```{r}
br_tm
length(unique(br_tm$Tm)) *           # Temperature incubators
   length(unique(br_tm$rep))       # Reps or individual leaves?
```

### Visualise the raw data  
Let's plot the data over time, we will need to omit temperatures 8 and 35 where
no germination was observed.

```{r plot_raw_timexRH}
g_vpd |>
   ggplot(aes(x = i_period, y = germ_n, colour = as.factor(Tm))) + 
   geom_point()+
   facet_wrap(facets = "RH")+
   geom_smooth(method = "gam",formula = y ~ s(x, k = 3))+
   scale_color_viridis_d()+
   xlab("Time in hours")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic() +
   ggtitle("Germinated conidia over time, subset by relative humidity")
   # scale_x_continuous(limits = c(12,48), breaks = c(12,18,24,30,36,42,48))++
   # scale_y_continuous(limits = c(0,100), n.breaks = 5)
   
```



```{r plot_raw_timexVPD}
i_p_labs <-c("12 hours","24 hours","36 hours","48 hours")
names(i_p_labs) <- c(12,24,36,48)
g_vpd |>
   ggplot(aes(x = vpd, y = germ_n, colour = as.factor(Tm))) + 
   geom_point()+
   facet_wrap(facets = c("i_period"), 
              labeller = labeller(i_period = i_p_labs))+
   geom_smooth(method = "gam",formula = y ~ bs(x,k=0.2), alpha = 0.3)+
   scale_color_viridis_d()+
   xlab("VPD")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic()

```

This data is very hard to fit a curve to and seems like it would benefit with two functions.
Lets plot again without the saturated 99% humidity treatment
```{r plot_subset_rh}
i_p_labs <-c("12 hours","24 hours","36 hours","48 hours")
names(i_p_labs) <- c(12,24,36,48)
g_vpd[g_vpd$RH != 99] |>
   ggplot(aes(x = vpd, y = germ_n, colour = as.factor(Tm))) + 
   geom_point()+
   facet_wrap(facets = c("i_period"), 
              labeller = labeller(i_period = i_p_labs))+
   geom_smooth(method = "gam",formula = y ~ s(x,k=5), alpha = 0.1)+
   scale_color_viridis_d()+
   xlab("VPD")+
   ylab("Germinated conidia (%)")+
   labs(colour = "Temperature")+
   theme_classic()
```

From these plots it seems that the influence of VPD on germination is bimodal, with an increase in germination between 1.5 and 2 kPa. 
Particularly in the warmer treatments

### VPD influence on germination - analysis
```{r m1v}
m1v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 5) + s(Tm, k = 3) + s(i_period, k = 3), 
           data = g_vpd,
           family = "binomial")
summary(m1v)
plot(m1v)
vis.gam(m1v)
```

As earlier, lets try and reduce the wiggliness by using P-splines  

```{r m2v}
m2v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 5, bs = "ps") + s(Tm, k = 3) + s(i_period, k = 3), 
           data = g_vpd,
           family = "binomial")
summary(m2v)
plot(m2v)
vis.gam(m2v,
        phi = 20,
        theta = 45)
```

There is a better fit and a decreasing trend in the vpd plot.  

Next lets try more vpd knots

```{r m3v}
m3v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 7, bs = "ps") + s(Tm, k = 3) + s(i_period, k = 3), 
           data = g_vpd,
           family = "binomial")
summary(m3v)
plot(m3v)
vis.gam(m3v,
        phi = 20,
        theta = 45)
par(mfrow = c(2,2),
    oma = c(0,0,0,0),
    mar = c(0.1,0.1,1,0.1))
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 12),
        main = "12 hours")
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 24),
        main = "24 hours")
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 36),
        main = "36 hours")
vis.gam(m3v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 48),
        main = "48 hours")

par(mfrow = c(1,1))
```

While there exists a lot of wiggliness in the gam, the vpd plot shows the increase in germination in at around 1.5 kPa and the rapid decrease in germination between the saturated treatments (0.026 - 0.038 kPa) and the next highest humidity (0.158 - 0.189 kpa).
This model also provides a high R-squared (`r round(summary(m3v)$r.sq,4)`), low UBRE `r round(m3v$gcv.ubre,3)`, indicating good predictive ability
and less affected by drop one, tests.


```{r}
m4v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 7) + Tm + s(i_period,k=3), 
           data = g_vpd,
           family = "binomial")
summary(m4v)
plot(m4v)
```

The wiggliness of the curve seems above 0.5 kPa seems to be more pronounced in warmer
temperature treatments. 
To evaluate if this is the case lets look at a temperature VPD interaction.  


```{r}
m5v <- gam(cbind(germ_n,non_germ_n) ~ te(vpd,Tm, k = 3)+ s(i_period,k=3), 
           data = g_vpd,
           family = "binomial")
summary(m5v)
anova(m4v,m5v)
```
This comparison shows no interaction between temperature and VPD.

```{r germ_bsmod}
b_k <- range(g_vpd$vpd) # set spline boundary knots
m6v <- gam(cbind(germ_n,non_germ_n) ~ s(vpd, k = 4,bs = "cs") + Tm + s(i_period,k=3),
           knots = list(vpd = c(b_k[1],0.1,0.4,b_k[2])),
           data = g_vpd,
           family = "binomial")


summary(m6v)
plot(m6v)

vis.gam(m6v,
        phi = 20,
        theta = 30,
        view = c("vpd","Tm"),
        #cond = list(i_period = 48),
        main = "48 hours")
```


```{r}
anova(m2v,m3v)
anova(m3v,m4v)
anova(m4v,m6v)
AIC(m1v,m2v,m3v, m4v, m5v, m6v)
```

Model four shows the best fit to the data 

```{r}
vis.gam(m6v,
        phi = 20,
        theta = 45)
par(mfrow = c(2,2),
    oma = c(0,0,0,0),
    mar = c(0.1,0.1,1,0.1))
vis.gam(m6v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 12),
        main = "12 hours")
vis.gam(m6v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 24),
        main = "24 hours")
vis.gam(m6v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 36),
        main = "36 hours")
vis.gam(m6v,
        phi = 20,
        theta = 45,
        view = c("vpd","Tm"),
        cond = list(i_period = 48),
        main = "48 hours")

par(mfrow = c(1,1))
```

### Impact of VPD on *P. xanthii* branching  

Import the clean data

```{r import_data_br}
# Read clean data
b_vpd <- fread("cache/branching_vpd.csv")[, exp := 1]
b_vpd2 <- fread("cache/branching_VPD2.csv")[,exp := 2]
b_vpd3 <- fread("cache/branching_VPD3.csv")[,exp := 3]

unique(b_vpd[,.(vpd,RH,Tm)])
unique(b_vpd2[,.(vpd,RH,Tm)])
unique(b_vpd3[,.(vpd,RH,Tm)])
summary(b_vpd2)
summary(b_vpd3)
```

<br>  
<br>  

## Impact of Temperature on *P. xanthii* germination  
There were three data-sets for 
Peek at the data

```{r data_peek_br}
str(b_vpd)
str(b_vpd2)
str(b_vpd3)
```
<br>  

Look at a summary of the data
```{r}
b_vpd[, list(n = mean(conidia)),
      by = list(vpd, Tm, branches)][order(vpd,Tm)]

b_vpd2[ ,list(n = mean(conidia)),
      by = list(vpd, Tm, branches)][order(vpd,Tm)]

b_vpd3[ ,list(n = mean(conidia)),
      by = list(vpd, Tm, branches)][order(vpd,Tm)]

b_v <-rbind(b_vpd,b_vpd2,b_vpd3)
```


### Visualise the raw data  
First we will observe the effect of vpd on the number of germtubes at 36 hours for
each experimental rep.  

```{r plot_br_vpd_exp}
b_v[,percent := (conidia/sum(conidia))*100,
    by = .(vpd,exp)] 
b_v |>
   ggplot(aes( x = as.factor(vpd), 
               y = percent ,
               fill = as.factor(branches))) + 
   geom_col()+
   facet_grid(rows = vars(exp))+
   scale_fill_brewer(palette = "Blues", name = "Germ tubes")+
   xlab("Vapour pressure deficit")+
   ylab("Percent germinated")+
   labs(colour = "Germ tubes")+
   theme_classic()+
   theme(axis.text.x = element_text(angle = 70, vjust = 1.7, hjust = 2))+
   geom_text(aes(x = as.factor(vpd), y = 115, label = paste0(Tm,"C")),size = 2.5)+
   scale_y_continuous(limits = c(0,120), breaks = c(0,25,50,75,100))
```
<br>  
Each experiment has similar trends and different variation for each vpd.  
<br>  
Next lets consolidate all the experimental data together

```{r plot_br_vpd}
b_v[,percent := (conidia/sum(conidia))*100,
    by = .(vpd)] 
b_v |>
   ggplot(aes( x = as.factor(vpd), 
               y = percent ,
               fill = as.factor(branches))) + 
   geom_col()+
   scale_fill_brewer(palette = "Blues", name = "Germ tubes")+
   xlab("Vapour pressure deficit")+
   ylab("Percent germinated")+
   labs(colour = "Germ tubes")+
   theme_classic()+
   theme(axis.text.x = element_text(angle = 70, vjust = 1.7, hjust = 2))+
   geom_text(aes(x = as.factor(vpd), y = 105, label = Tm),size = 3,)+
   scale_y_continuous(limits = c(0,110), breaks = c(0,25,50,75,100))
```

What is the mean differences between the most saturated treatments 0.026 - 0.038 and
the next highest saturated treatments 0.132 - 0.186?  

```{r}
b_v[vpd == 0.026 &
       branches == 3, sum(percent)] -
   b_v[vpd == 0.132 &
       branches == 3, sum(percent)]

b_v[vpd == 0.032 &
       branches == 3, sum(percent)] -
   b_v[vpd == 0.158 &
       branches == 3, sum(percent)]

b_v[vpd == 0.038 &
       branches == 3, sum(percent)] -
   b_v[vpd == 0.189 &
       branches == 3, sum(percent)]

```


### Analysis of conidial germination and germtube proliferation
In order to analyse the data we need to convert the data to a longer format, where
each row represents an observation.

```{r model_1}
b_vpd_lng <-
   rbindlist(apply(b_v, 1 , function(x) {
      rbindlist(lapply(seq_len(x["conidia"]), function(x2) {
         as.data.frame(t(x[c(1:4,6,7)]))
      })
      )
   }))

b_vpd_lng[, c("exp",
              "rep",
              "branches",
              "cham",
              "vpd") := list(as.integer(exp),
                             as.integer(rep),
                             as.ordered(branches),
                             paste0(Tm, RH),
                             as.numeric(vpd))]

```

Test change

```{r}
# m1.1 <- stan_polr(germ_tubes ~ vpd + Tm, chains = 1,
#                   prior = R2(0.5, what = "median"), 
#                   data = b_vpd_lng)
# summary(m1.1)


m1 <- polr(branches ~ vpd + Tm+exp, data = b_vpd_lng, Hess = TRUE)

summary(m1)
```

Lets try predicting from this model so we can plot how it performs.
First we need to make som test data.

```{r test_dat}
# Make a data.frame of test values to feed in the model
test_dat <- data.table(Tm = rep(seq(from = 22, to = 28, by = 1),
                                each = 256,
                                times = 3), # between 5 and 8 degrees
                       vpd = rep(seq(from = 0.020, to = 2.57, by = 0.01),
                                 times = 7*3),
                       exp = rep(1:3,
                                 each = 7*256)
                       #rep = as.factor(rbinom(length(seq(from = 5, to = 40, by = 0.1)),1,0.5)+1)
                       ) # randomly use either the first or second rep
```

```{r, fig.dim=c(7,10)}
# create a data.frame with predicted values and reference them to the respective temperature
m1_pred <-
   as.data.table(cbind(test_dat,
                       round(predict(m1,
                                     test_dat,
                                     type = "p"),
                             3)))

# format to long 
m1_pred <-
   melt(
      m1_pred,
      id.vars = c("Tm","vpd","exp"),
      measure.vars = c("0", "1", "2", "3"),
      variable.name = "branches",
      value.name = "prob"
   )

m1_pred |>
   ggplot(aes(x = vpd, y = prob, colour = branches))+
   facet_grid(rows = vars(Tm), cols = vars(exp))+
   geom_line(size = 1)+
   theme_minimal()
```
There is a lot going on in this graph but as the `m1` summary shows experimental rep,
temperature and VPD were all significant. For ease in interpretation, lets look at 
a consolidated plot.  

```{r}
m1_pred[,.(prob = mean(prob)),by= .(vpd,branches)] |>
   ggplot(aes(x = vpd, y = prob, colour = branches))+
#   facet_wrap(facets = vars(Tm))+
   geom_line(size = 1)+
   theme_minimal()
```


<br>  
Model two we will investigate whether there is an interaction between temperature 
and infection period.  

```{r model_2}
m2 <- polr(branches ~ bs(vpd,knots = 0.5) + Tm + exp, data = b_vpd_lng, Hess = TRUE)
summary(m2)
```
Let's predict from this model to consider it's performance.


```{r}
# create a data.frame with predicted values and reference them to the respective temperature
m2_pred <-
   as.data.table(cbind(test_dat,
                       round(predict(m2,
                                     test_dat,
                                     type = "p"),
                             3)))

# format to long 
m2_pred <-
   melt(
      m2_pred,
      id.vars = c("Tm","vpd","exp"),
      measure.vars = c("0", "1", "2", "3"),
      variable.name = "branches",
      value.name = "prob"
   )

m2_pred[,.(prob = mean(prob)),by= .(vpd,Tm,branches)] |>
   ggplot(aes(x = vpd, y = prob, colour = branches))+
   facet_wrap(facets = vars(Tm))+
   geom_line(size = 1)+
   theme_minimal()
```

There is a consistent effect of temperature that increases the number of germinated
and branching germ-tubes. 
Low VPD has a strong effect on the number and proportion of branching germtubes.
While the number of germinated conidia and germtube branching decreases rapidly as 
VPD increases, however after 0.5 kPa, the proportion of germinating and branching 
conidia stabilise all the way up to 2 kPa.  

Lets look at just VPD and drop the temperature effect.

```{r}
m2_pred[,.(prob = mean(prob)),by= .(vpd,branches)] |>
   ggplot(aes(x = vpd, y = prob, colour = branches))+
   #facet_wrap(facets = vars(Tm))+
   geom_line(size = 1)+
   theme_minimal()
```

Given the plots show a decent similarity to the raw data we will choose `m2`.
Lets now extract the coefficients

```{r m2_coefTab}
# get table of coefficients
coef_table <- data.table(coef(summary(m2)), keep.rownames = TRUE)

# calculate p-values
coef_table[, p_value := pnorm(abs(`t value`),lower.tail = FALSE) *2][, sig := p_star(p_value)]
coef_table
```



## Baysian approach  

```{r install_stan, include=FALSE}
#install.packages("rstanarm")
library(rstanarm)
library(bayesplot)
```

```{r, include=FALSE}
# fit1 <- stan_gamm4(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k = 3) + s(Tm, k = 6, bs = "ps"), 
#                    data = g_tm, family = "binomial", chains = 1)
# 
# plot_nonlinear(fit1)
# 
# m5 <- gam(cbind(germ_conidia, non_germ_conidia) ~ s(i_period, k=3) + s(Tm, k =4, bs = "ps"),
#           data = g_tm,
#           family = "binomial",
# )
# 
# prior_summary(fit1)
# summary(fit1)
# mcmc_areas(as.matrix(fit1),
#            pars = "Tm",
#            prob = 0.95)
# pp_check(fit1,"stat")
```


```{r, include=FALSE}
# g_vpd %>%
#   mutate(germ = germ_n/(non_germ_n + germ_n)) %>%
#   group_by(vpd,i_period) %>%
#   summarise(m_germ = mean(germ),
#             Tm= unique(Tm)) %>%
#    filter(i_period == 12 &
#              vpd > 0.13) %>%
#    summary()
```
